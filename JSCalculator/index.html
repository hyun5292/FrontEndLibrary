<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"/>
    <link rel="stylesheet" href="./css/default.css">
    <link rel="stylesheet" href="./css/index.css">
    <title>JavaScript Calculator</title>
</head>
<body>
    <div id="app"></div>

    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script type="text/babel">
        const projectName = 'javascript-calculator';

        const isOperator = /[x/+-]/,
        endsWithnegativeSign = /[x+-/]$/,
        clearStyle = { background: '#ac3939' },
        operatorStyle = { background: '#666666' },
        equalsStyle = { 
            position: 'absolute',
            bottom: 5,
            height: 130,
            background: '#004466'
        };

        class Calculator extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    currentVal: '0',
                    prevval: '0',
                    formula: '',
                    currentSign: 'pos',
                    lastClicked: ''
                };
                this.maxDigitWarning = this.maxDigitWarning.bind(this);
                this.handleOperators = this.handleOperators.bind(this);
                this.hadleEvaluate = this.hadleEvaluate.bind(this);
                this.initialize = this.initialize.bind(this);
                this.handleDecimal = this.handleDecimal.bind(this);
                this.handleNumbers = this.handleNumbers.bind(this);
            }

            //최고점이 있는 계산기였구낭
            maxDigitWarning() {
                this.setState({
                    currentBal: 'Digit Limit Met',
                    prevVal: this.state.currentVal
                });
                setTimeout(() => this.setState({ currentVal: this.state.prevVal }), 1000);
            }

            handleEvaluate() {
                if(!this.state.currentVal.includes('Limit')) {  //최고점을 안넘었으면
                    let expression = this.state.formula;  //현재 계산 공식
                    while(endsWithOperator.test(expression)) {  //공식이 x, +, -, /로 끝나는 동안
                        expression = expression.slice(0, -1);  //끝에서 1개 발췌?
                    }
                    expression = expression
                        .replace(/x/g, '*')  //계산은 x가 아니라 *로 하니까
                        .replace(/-/g, '-')
                        .replace('--', '+0+0+0+0+0+0+');  //이건 또 뭘까
                    //계산해서 왜 1000000000000을 곱하고 나누는걸까?
                    let answer = Math.round(1000000000000 * eval(expression)) / 1000000000000;
                    this.setState({
                        currentVal: answer.toString(),
                        formula:
                            expression
                                .replace(/\*/g, '⋅')
                                .replace(/-/g, '-')
                                .replace('+0+0+0+0+0+0+', '--')
                                .replace(/(x|\/|\+)-/, '$1-')
                                .replace(/^-/, '-') + '=' + answer,
                            prevVal: answer,
                            evaluated: true
                    });
                }
            }

            handleOperators(e) {
                if(!this.state.currentVal.includes('Limit')) {
                    const value = e.target.value;
                    const { formula, prevVal, evaluated } = this.state;
                    this.setState({ currentVal: value, evaluated: false });
                    if(evaluated) {
                        this.setState({ formula: prevVal + value });
                    } else if(!endsWithOperator.test(formula)) {
                        this.setState({
                            formula:
                                (endsWithNegativeSign.test(formula + value) ? formula : prevVal) + value
                        });
                    } 
                }
            }
        };

        ReactDOM.render(<Calculator />, document.getElementById("app"));
    </script>
</body>
</html>